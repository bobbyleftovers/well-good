<?php

// For testing
// delete_post_meta($post->ID, 'wag_rating');

function get_votes_average( $array ) {
  $average = array_sum($array) / count($array);
  return round($average);
}

$rating = get_post_meta( $post->ID, 'wag_rating', true );
$rating_data = $rating ? json_decode( $rating, true ) : null;

if( isset($_COOKIE['STYXKEY_wag_rating']) ) {
  $display = json_decode(stripslashes($_COOKIE['STYXKEY_wag_rating']), true)[$post->ID];
} else {
  $display = $rating ? get_votes_average( $rating_data ) : 0;
}

?>

<svg data-module-init="rating" class="rating__stars" data-post-id="<?= $post->ID ?>" data-rating="<?= $display ?>" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 250.8 41.8" role="complementary">
  <path class="rating__star" d="M40.3,16.2c0,0.3-0.2,0.7-0.6,1.1l-8.4,8.2l2,11.5c0,0.1,0,0.3,0,0.5c0,0.3-0.1,0.6-0.2,0.8c-0.2,0.2-0.4,0.3-0.7,0.3
    c-0.3,0-0.6-0.1-0.9-0.3l-10.3-5.4l-10.3,5.4c-0.3,0.2-0.6,0.3-0.9,0.3c-0.3,0-0.6-0.1-0.7-0.3C9,38,8.9,37.7,8.9,37.4
    c0-0.1,0-0.2,0-0.5l2-11.5l-8.4-8.2C2.2,16.9,2,16.5,2,16.2c0-0.6,0.4-0.9,1.3-1.1l11.6-1.7L20,2.9C20.3,2.3,20.7,2,21.2,2
    c0.5,0,0.8,0.3,1.1,0.9l5.2,10.5L39,15.1C39.9,15.2,40.3,15.6,40.3,16.2z"/>
  <path class="rating__star" d="M88.6,16.2c0,0.3-0.2,0.7-0.6,1.1l-8.4,8.2l2,11.5c0,0.1,0,0.3,0,0.5c0,0.3-0.1,0.6-0.2,0.8c-0.2,0.2-0.4,0.3-0.7,0.3
    c-0.3,0-0.6-0.1-0.9-0.3l-10.3-5.4l-10.3,5.4c-0.3,0.2-0.6,0.3-0.9,0.3c-0.3,0-0.6-0.1-0.7-0.3c-0.2-0.2-0.2-0.5-0.2-0.8
    c0-0.1,0-0.2,0-0.5l2-11.5l-8.4-8.2c-0.4-0.4-0.6-0.8-0.6-1.1c0-0.6,0.4-0.9,1.3-1.1l11.6-1.7l5.2-10.5C68.6,2.3,68.9,2,69.4,2
    s0.8,0.3,1.1,0.9l5.2,10.5l11.6,1.7C88.1,15.2,88.6,15.6,88.6,16.2z"/>
  <path class="rating__star" d="M137.8,16.2c0,0.3-0.2,0.7-0.6,1.1l-8.4,8.2l2,11.5c0,0.1,0,0.3,0,0.5c0,0.3-0.1,0.6-0.2,0.8c-0.2,0.2-0.4,0.3-0.7,0.3
    c-0.3,0-0.6-0.1-0.9-0.3l-10.3-5.4l-10.3,5.4c-0.3,0.2-0.6,0.3-0.9,0.3c-0.3,0-0.6-0.1-0.7-0.3c-0.2-0.2-0.2-0.5-0.2-0.8
    c0-0.1,0-0.2,0-0.5l2-11.5l-8.4-8.2c-0.4-0.4-0.6-0.8-0.6-1.1c0-0.6,0.4-0.9,1.3-1.1l11.6-1.7l5.2-10.5c0.3-0.6,0.7-0.9,1.1-0.9
    c0.5,0,0.8,0.3,1.1,0.9l5.2,10.5l11.6,1.7C137.4,15.2,137.8,15.6,137.8,16.2z"/>
  <path class="rating__star" d="M186.4,16.2c0,0.3-0.2,0.7-0.6,1.1l-8.4,8.2l2,11.5c0,0.1,0,0.3,0,0.5c0,0.3-0.1,0.6-0.2,0.8c-0.2,0.2-0.4,0.3-0.7,0.3
    c-0.3,0-0.6-0.1-0.9-0.3l-10.3-5.4l-10.3,5.4c-0.3,0.2-0.6,0.3-0.9,0.3c-0.3,0-0.6-0.1-0.7-0.3c-0.2-0.2-0.2-0.5-0.2-0.8
    c0-0.1,0-0.2,0-0.5l2-11.5l-8.4-8.2c-0.4-0.4-0.6-0.8-0.6-1.1c0-0.6,0.4-0.9,1.3-1.1l11.6-1.7l5.2-10.5c0.3-0.6,0.7-0.9,1.1-0.9
    s0.8,0.3,1.1,0.9l5.2,10.5l11.6,1.7C186,15.2,186.4,15.6,186.4,16.2z"/>
  <path class="rating__star" d="M235.7,16.2c0,0.3-0.2,0.7-0.6,1.1l-8.4,8.2l2,11.5c0,0.1,0,0.3,0,0.5c0,0.3-0.1,0.6-0.2,0.8c-0.2,0.2-0.4,0.3-0.7,0.3
    c-0.3,0-0.6-0.1-0.9-0.3l-10.3-5.4l-10.3,5.4c-0.3,0.2-0.6,0.3-0.9,0.3c-0.3,0-0.6-0.1-0.7-0.3c-0.2-0.2-0.2-0.5-0.2-0.8
    c0-0.1,0-0.2,0-0.5l2-11.5l-8.4-8.2c-0.4-0.4-0.6-0.8-0.6-1.1c0-0.6,0.4-0.9,1.3-1.1l11.6-1.7l5.2-10.5c0.3-0.6,0.7-0.9,1.1-0.9
    s0.8,0.3,1.1,0.9l5.2,10.5l11.6,1.7C235.3,15.2,235.7,15.6,235.7,16.2z"/>
</svg>
<span class="js-rating-notice rating__status">Add a rating</span>
